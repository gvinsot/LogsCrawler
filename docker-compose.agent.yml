# Docker Compose for LogsCrawler Agent
#
# Deploy this on each host you want to monitor.
# The agent will:
# - Collect Docker container logs and metrics
# - Write directly to OpenSearch
# - Poll the backend for actions (start, stop, exec, etc.)
#
# Usage:
#   docker-compose -f docker-compose.agent.yml up -d

version: "3.8"

services:
  agent:
    build:
      context: .
      dockerfile: Dockerfile.agent
    container_name: logscrawler-agent
    restart: unless-stopped
    # Privileged mode for GPU device access
    privileged: true
    volumes:
      # Mount Docker socket for container access
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # System and GPU device access for monitoring
      - /sys:/sys:ro
      - /dev/dri:/dev/dri:ro
      - /dev/kfd:/dev/kfd:ro
    environment:
      # AMD GPU visibility
      - AMD_VISIBLE_DEVICES=all
      
      # Unique agent ID (use hostname or custom name)
      - AGENT_AGENT_ID=${AGENT_ID:-$(hostname)}

      # Backend URL for polling actions
      - AGENT_BACKEND_URL=${BACKEND_URL:-http://logscrawler-backend:8000}

      # OpenSearch connection (direct writes)
      - AGENT_OPENSEARCH__HOSTS=${OPENSEARCH_HOSTS:-["http://opensearch:9200"]}
      - AGENT_OPENSEARCH__USERNAME=${OPENSEARCH_USERNAME:-}
      - AGENT_OPENSEARCH__PASSWORD=${OPENSEARCH_PASSWORD:-}
      - AGENT_OPENSEARCH__INDEX_PREFIX=${OPENSEARCH_INDEX_PREFIX:-logscrawler}

      # Docker socket path (inside container)
      - AGENT_DOCKER_URL=unix:///var/run/docker.sock

      # Collection intervals
      - AGENT_LOG_INTERVAL=${LOG_INTERVAL:-30}
      - AGENT_METRICS_INTERVAL=${METRICS_INTERVAL:-15}
      - AGENT_ACTION_POLL_INTERVAL=${ACTION_POLL_INTERVAL:-2}
    networks:
      - logscrawler

networks:
  logscrawler:
    external: true
